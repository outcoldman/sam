/*jshint globalstrict: true*/ 'use strict';

var archiver = require('archiver'),
    path = require('path'),
    zlib = require('zlib'),
    fs = require('fs');

var DEFAULT_SOURCE = [
  './**/*',
  '!./local/**',
  '!./*.tar.gz'
];

module.exports = function(grunt) {
  grunt.registerTask('splunk-pack', 'Pack application into tar.gz archive for uploading to the store', function() {
    var sourceDir = grunt.config('splunk.pack.sourceDir') || process.cwd();
    var source = grunt.config('splunk.pack.source') || ['**/*'];
    var outputFile = grunt.config('splunk.pack.output') || path.join(sourceDir, 'app.tar.gz');

    var gzipper = zlib.createGzip();
    var output = fs.createWriteStream(outputFile);
    var archive = archiver('tar');

    var done = this.async();

    output.on('close', function() {
      grunt.log.debug(archive.pointer() + ' total bytes');
      grunt.log.debug('archiver has been finalized and the output file descriptor has closed.');
      done();
    });

    archive.on('error', function(err) {
      grunt.fatal(err);
    });

    archive.pipe(gzipper).pipe(output);

    archive.bulk([
      { expand: true, cwd: sourceDir, src: source, dest: grunt.config('splunk.splunkApp') }
    ]);

    archive.finalize();
  });
};